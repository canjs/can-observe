<!DOCTYPE html>

<html>
<head>
  <title>-memoize-getter.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="array.html">
                  array.js
                </a>
              
                
                <a class="source" href="can-observe.html">
                  can-observe.js
                </a>
              
                
                <a class="source" href="object.html">
                  object.js
                </a>
              
                
                <a class="source" href="-getter-helpers.html">
                  -getter-helpers.js
                </a>
              
                
                <a class="source" href="-helpers.html">
                  -helpers.js
                </a>
              
                
                <a class="source" href="-make-array.html">
                  -make-array.js
                </a>
              
                
                <a class="source" href="-make-function.html">
                  -make-function.js
                </a>
              
                
                <a class="source" href="-make-object.html">
                  -make-object.js
                </a>
              
                
                <a class="source" href="-make-observe.html">
                  -make-observe.js
                </a>
              
                
                <a class="source" href="-make-simple-function.html">
                  -make-simple-function.js
                </a>
              
                
                <a class="source" href="-memoize-getter-test.html">
                  -memoize-getter-test.js
                </a>
              
                
                <a class="source" href="-memoize-getter.html">
                  -memoize-getter.js
                </a>
              
                
                <a class="source" href="-observable-store.html">
                  -observable-store.js
                </a>
              
                
                <a class="source" href="-symbols.html">
                  -symbols.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="-memoize-getter-js">-memoize-getter.js</h1>
<p>Exports a function that rewrites a getter to use an Observation
under-the-hood.  This makes it so getters are cached.
The observations are created lazily for each instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> Observation = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-observation"</span>);
<span class="hljs-keyword">var</span> ObservationRecorder = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-observation-recorder"</span>);
<span class="hljs-keyword">var</span> observableStore = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./-observable-store"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="memoizedgetterobservationdata">MemoizedGetterObservationData</h2>
<p>Instances of this are created to wrap the observation.
The <code>.bind</code> and <code>.unbind</code> methods should be called when the
instanceâ€™s key is bound or unbound.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">MemoizedGetterObservationData</span>(<span class="hljs-params">instance, prop, getter</span>)</span>{
    <span class="hljs-keyword">this</span>.prop = prop;
    <span class="hljs-keyword">this</span>.instance = instance;
    <span class="hljs-keyword">this</span>.forward = <span class="hljs-keyword">this</span>.forward.bind(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.observation = <span class="hljs-keyword">new</span> Observation(getter, instance, {<span class="hljs-attr">isObservable</span>: <span class="hljs-literal">false</span>});
}

MemoizedGetterObservationData.prototype.bind = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">observationData</span>)</span>{
    <span class="hljs-keyword">this</span>.bindingCount++;
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.bindingCount === <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">this</span>.observation.on(<span class="hljs-keyword">this</span>.forward, <span class="hljs-string">"notify"</span>);
    }
};
MemoizedGetterObservationData.prototype.unbind = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">observationData</span>)</span>{
    <span class="hljs-keyword">this</span>.bindingCount--;
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.bindingCount === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">this</span>.observation.off(<span class="hljs-keyword">this</span>.forward, <span class="hljs-string">"notify"</span>);
    }
};
MemoizedGetterObservationData.prototype.forward = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue, oldValue</span>)</span>{
    <span class="hljs-keyword">this</span>.instance.dispatch({
        <span class="hljs-attr">type</span>: <span class="hljs-keyword">this</span>.prop,
        <span class="hljs-attr">target</span>: <span class="hljs-keyword">this</span>.instance
    }, [newValue, oldValue]);
};
MemoizedGetterObservationData.prototype.bindingCount = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="memoize">memoize</h2>
<p>Changes a <code>getter</code> to use an observation.</p>
<ul>
<li>Type - A constructor function.</li>
<li>prop - A property name.</li>
<li>definition - A property definition that includes a <code>.get</code>.</li>
</ul>
<p>Returns a <code>getObservationDataFor(instance)</code> that will return or create an instance
of <code>MemoizedGetterObservationData</code> for the instance passed in. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">memoize</span>(<span class="hljs-params">Type, prop, definition</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Store the observation data for each instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> instanceToObservationData = <span class="hljs-keyword">new</span> <span class="hljs-built_in">WeakMap</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Returns or creates the observation data for the instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getObservationDataFor</span>(<span class="hljs-params">instance</span>)</span>{
        <span class="hljs-keyword">var</span> observationData = instanceToObservationData.get(instance);
        <span class="hljs-keyword">if</span>(!observationData) {
            observationData = <span class="hljs-keyword">new</span> MemoizedGetterObservationData(instance, prop, definition.get);
            instanceToObservationData.set(instance, observationData);
        }
        <span class="hljs-keyword">return</span> observationData;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Overwrite the getter to read from the observation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">Object</span>.defineProperty(Type, prop,{
        <span class="hljs-attr">enumerable</span>: definition.enumerable,
        <span class="hljs-attr">get</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">memoized</span>(<span class="hljs-params"></span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Get the instance and its observation data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> instance = observableStore.proxiedObjects.get(<span class="hljs-keyword">this</span>) || <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">var</span> observationData = getObservationDataFor(instance);

            ObservationRecorder.add(instance,prop.toString());
            <span class="hljs-keyword">if</span>( !observationData.observation.bound &amp;&amp; ObservationRecorder.isRecording() ) {
                Observation.temporarilyBind(observationData.observation);
            }
            <span class="hljs-keyword">return</span> observationData.observation.get();
        }
    });

    <span class="hljs-keyword">return</span> getObservationDataFor;
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
