<!DOCTYPE html>

<html>
<head>
  <title>-make-function.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="array.html">
                  array.js
                </a>
              
                
                <a class="source" href="can-observe.html">
                  can-observe.js
                </a>
              
                
                <a class="source" href="object.html">
                  object.js
                </a>
              
                
                <a class="source" href="-getter-helpers.html">
                  -getter-helpers.js
                </a>
              
                
                <a class="source" href="-helpers.html">
                  -helpers.js
                </a>
              
                
                <a class="source" href="-make-array.html">
                  -make-array.js
                </a>
              
                
                <a class="source" href="-make-function.html">
                  -make-function.js
                </a>
              
                
                <a class="source" href="-make-object.html">
                  -make-object.js
                </a>
              
                
                <a class="source" href="-make-observe.html">
                  -make-observe.js
                </a>
              
                
                <a class="source" href="-make-simple-function.html">
                  -make-simple-function.js
                </a>
              
                
                <a class="source" href="-memoize-getter-test.html">
                  -memoize-getter-test.js
                </a>
              
                
                <a class="source" href="-memoize-getter.html">
                  -memoize-getter.js
                </a>
              
                
                <a class="source" href="-observable-store.html">
                  -observable-store.js
                </a>
              
                
                <a class="source" href="-symbols.html">
                  -symbols.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="-make-function-js">-make-function.js</h1>
<p>This module’s <code>.observable</code> method proxies an function to make it an any instances
created by it observable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> canReflect = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-reflect"</span>);
<span class="hljs-keyword">var</span> makeObject = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./-make-object"</span>);
<span class="hljs-keyword">var</span> symbols = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./-symbols"</span>);
<span class="hljs-keyword">var</span> observableStore = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./-observable-store"</span>);
<span class="hljs-keyword">var</span> mapBindings = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-event-queue/map/map"</span>);
<span class="hljs-keyword">var</span> typeBindings = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-event-queue/type/type"</span>);
<span class="hljs-keyword">var</span> helpers = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./-helpers"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="proxykeys">proxyKeys</h2>
<p>A function’s proxyKeys is a combination of:</p>
<ul>
<li>object’s symbols (<code>.onKeyValue</code>)</li>
<li>type event symbols (<code>.onInstancePatches</code>, <code>.onInstanceBound</code>)</li>
<li>type definition symbols (<code>.defineInstanceKey</code>)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> proxyKeys = helpers.assignEverything(<span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>), makeObject.proxyKeys());
typeBindings(proxyKeys);
canReflect.assignSymbols(proxyKeys, {
	<span class="hljs-string">"can.defineInstanceKey"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">prop, value</span>) </span>{
		<span class="hljs-keyword">this</span>[symbols.metaSymbol].definitions[prop] = value;
	}
});

<span class="hljs-keyword">var</span> makeFunction = {

	<span class="hljs-attr">observable</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">object, options</span>) </span>{

		<span class="hljs-keyword">if</span>(options.shouldRecordObservation === <span class="hljs-literal">undefined</span>) {
			options.shouldRecordObservation = makeObject.shouldRecordObservationOnOwnAndMissingKeys;
		}
		<span class="hljs-keyword">var</span> proxyKeys = <span class="hljs-built_in">Object</span>.create(makeFunction.proxyKeys());

		<span class="hljs-keyword">var</span> meta = {
			<span class="hljs-attr">target</span>: object,
			<span class="hljs-attr">proxyKeys</span>: proxyKeys,
			<span class="hljs-attr">options</span>: options,
			<span class="hljs-attr">definitions</span>: {},
			<span class="hljs-attr">isClass</span>: helpers.isClass(object),
			<span class="hljs-attr">preventSideEffects</span>: <span class="hljs-number">0</span>
		};

		proxyKeys[symbols.metaSymbol] = meta;
		meta.proxy = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Proxy</span>(object, {
			<span class="hljs-attr">get</span>: makeObject.get.bind(meta),
			<span class="hljs-attr">set</span>: makeObject.set.bind(meta),
			<span class="hljs-attr">ownKeys</span>: makeObject.ownKeys.bind(meta),
			<span class="hljs-attr">deleteProperty</span>: makeObject.deleteProperty.bind(meta),
			<span class="hljs-attr">construct</span>: makeFunction.construct.bind(meta),
			<span class="hljs-attr">apply</span>: makeFunction.apply.bind(meta),
			<span class="hljs-attr">meta</span>: meta
		});

		mapBindings.addHandlers(meta.proxy, meta);
		typeBindings.addHandlers(meta.proxy, meta);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Store the function and its proxy now, before we
convert the prototype and its constructor to proxies.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		observableStore.proxiedObjects.set(object, meta.proxy);
		observableStore.proxies.add(meta.proxy);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Change prototype and its constructor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (meta.target.prototype &amp;&amp; meta.target.prototype.constructor === meta.target) {
			<span class="hljs-keyword">var</span> prototype = meta.proxy.prototype;
			prototype.constructor = meta.proxy;
		}

		<span class="hljs-keyword">return</span> meta.proxy;
	},</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><code>construct</code> is called when the <code>new</code> operator is used.
It needs to return an observable instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	construct: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">target, argumentsList, newTarget</span>) </span>{

		<span class="hljs-keyword">var</span> instanceTarget, key;
		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isClass) {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>If the <code>target</code> a class, we can’t call the function without new. We
can create the instance with <code>Reflect.construct</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			instanceTarget = <span class="hljs-built_in">Reflect</span>.construct(target, argumentsList, newTarget);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Support <code>can.defineInstanceKey</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">for</span> (key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.definitions) {
				<span class="hljs-built_in">Object</span>.defineProperty(instanceTarget, key, <span class="hljs-keyword">this</span>.definitions[key]);
			}
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.options.observe(instanceTarget);
		} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Create an empty object that inherits from the constructor function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			instanceTarget = <span class="hljs-built_in">Object</span>.create(<span class="hljs-keyword">this</span>.proxy.prototype);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Support <code>can.defineInstanceKey</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">for</span> (key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.definitions) {
				<span class="hljs-built_in">Object</span>.defineProperty(instanceTarget, key, <span class="hljs-keyword">this</span>.definitions[key]);
			}
			<span class="hljs-keyword">var</span> instance = <span class="hljs-keyword">this</span>.options.observe(instanceTarget);
			instance[symbols.metaSymbol].preventSideEffects++;
			<span class="hljs-keyword">var</span> res = target.apply(instance, argumentsList);
			instance[symbols.metaSymbol].preventSideEffects--;
			<span class="hljs-keyword">if</span> (res) {
				<span class="hljs-keyword">return</span> res;
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-keyword">return</span> instance;
			}
		}
	},</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><code>apply</code> makes sure the function returns an observable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	apply: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">target, thisArg, argumentsList</span>) </span>{
		<span class="hljs-keyword">var</span> ret = <span class="hljs-keyword">this</span>.target.apply(thisArg, argumentsList);
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.options.observe(ret);
	},
	<span class="hljs-attr">proxyKeys</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> proxyKeys;
	}
};

<span class="hljs-built_in">module</span>.exports = makeFunction;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
